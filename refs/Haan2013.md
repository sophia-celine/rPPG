# Robust Pulse Rate From Chrominance-Based rPPG

*G. de Haan and V. Jeanne, "Robust Pulse Rate From Chrominance-Based rPPG," in IEEE Transactions on Biomedical Engineering, vol. 60, no. 10, pp. 2878-2886, Oct. 2013, doi: 10.1109/TBME.2013.2266196*

CHROM algorithm

- main concern of rPPG is motion robustness

## Analysis

**Assumptions**

- Area of the skin is illuminated by a light source and registered with an RGB camera
- Blood volume changes due to heartbeat lead to color changes in light reflected by the skin
- Given the pulsatility as a function of wavelength exhibits a strong peak in green and the dips in red , the ratio of normalized green and red would make a motion robust pulse signal
    - so-called RoverG method
- Light reflected by the skin has two components
    - diffuse (body) reflection component - reflects variations due to cardaic cycle
    - directly reflected component

This division in two components is also mentioned by Kumar, 2015

> In general, the measured intensity of any reflected light can be decomposed into two components: (i) intensity of illumination, and (ii) reflectance of the surface (skin)

*Kumar M, Veeraraghavan A, Sabharwal A. DistancePPG: Robust non-contact vital signs monitoring using a camera. Biomed Opt Express. 2015 Apr 6;6(5):1565-88. doi: 10.1364/BOE.6.001565. PMID: 26137365; PMCID: PMC4467696.*
> 

**Modeling of the light intensity**

$$
C_i = I_{C_i}(\rho_{C_{dc}} + \rho_{C_i})
$$

- $I_{C_i}$ is the intensity of the light source integrated over the exposure time of teh camera image $i$ for the color channel $C$
- $\rho_{C_{dc}}$ is the stationary part of the reflection coefficient of the skin in the color channel C
- $\rho_{C_i}$ indicates the zero-mean time-varying fraction caused by the pulsation of the blood volume

**Amplitude of heartbeat-induced color varation**

$$
C_{ni} = \frac{C_i}{\mu(C_i)}
$$

- $\mu(C_i)$ is an average over a set of images that contain the image $i$ an preferably contains at least one pulse period
    - running average or average of overlap-add  procesing interval

Ratio of normalized green and red should make a motion robust pulse signal $S_i$ (RoverG)

$$
S_i = \frac{G_{ni}}{R_{ni}} - 1 = \frac{G_i}{R_i} \cdot \frac{\mu(R_i)}{\mu(G_i)} - 1
$$

**Model including specular reflection** 

$$
C_i = I_{C_i}(\rho_{C_{dc}} + \rho_{C_i} + s_i)
$$

- $s_i$ is the additive specular reflection contribution
    - identical for all color channels
    - stationary part is different for each color channel: red > green > blue

**Chrominance**

> If we, initially, assume white light, we note that the specular reflection affects all the channels
by adding an identical (white light) specular fraction to their respective diffuse reflection component. This implies that we can eliminate the specular reflection component by using color difference, i.e., chrominance, signals.
> 
- Two orthogonal chrominance signals from the RGB channels
    - $X = R − G$
    - $Y = 0.5R + 0.5G − B$

**XoverY algorithm**

$$
S = \frac{X_n}{Y_n} - 1
$$

- asssumes white illumination
- standardization of skin-tone:  a **fixed skin-tone** where the normalized skin tone $[R, G, B]/\sqrt{R^2 + G^2 + B^2}$, [R,G,B]/ √R2 + G2 + B2 , is assumed to be the same for everyone under white light
    - $[R_S, G_s, B_s] = [0.7682, 0.5121, 0.3841]$ — obtained from the experiment
    - We now can correct for potentially nonwhite illumination by first dividing the individual color channels by their means and next multiply [Rn ,Gn ,Bn ] with [0.7682, 0.5121, 0.3841]
    
    $$
    S = \frac{X_s}{Y_s} - 1
    $$
    
    $$
    X_s = \frac{R_s - G_s}{0.7682 − 0.5121} = 3R_n - 2G_n
    $$
    
    $$
    Y_s = \frac{R_S + G_s - 2B_s}{0.7682 + 0.5121 − 0.7682} = 1.5 R_n + G_n - 1.5 B_n
    $$
    

This method is similar to ICA and PCA as the estimated signal can also be written as a linear combination of RGB channels

- $S \approx X_S - Y_s = 1.5R_n - 3G_n + 1.5B_n$
- proposed algorithm is denoted as fixed as it does not require further heuristics to distinguish the pulse signa from other components of the RGB channels
- Corrections for if X an Y do not have identical amplitudes

- $S = X_f - \alpha Y_f$

- $\alpha = \frac{\sigma(X_f)}{\sigma(Y_f)}$
- $\sigma(X_f)$ is the standard deviation of $X_f$ which is he bandpass filtered signal of $X_s$

FInal algorithm

$$
S = 3\left(1 - \frac{\alpha}{2}\right)R_f - 2\left(1 + \frac{\alpha}{2}\right)G_f + \frac{3\alpha}{2}B_f
$$

## Assessment details

### Setup

- 1024 × 752 pixels, 8 bit, global shutter RGB CCD camera (type USB UI-2230SE-C of IDS Gmbh)
    - C-mount lens (Tamron 12VM412ASIR)
- 20 FPS
- face as ROI
- 1 min videos
- Uncompressed data
- Ground truth: pulse-oximeter finger clip of Contec Medical Systems, model CMS50E

> To extract the pulse rate from the output signals of the different methods, we simply performed a peak detection in
the frequency domain using a 512 point FFT on the Hanning windowed signals
> 
- outputs preprocessed  using an FIR (finite impulse response) bandpass filter with cutoff frequencies 40–240 beats/min to select the pulse frequencies.
- skin pigmentation analyzer, SPA 99, from Courage and Khazaka to analyze sybjects skin classification according to Fitzpatrick phototypes.

Fitzpatrick scale

| **Type** | **Skin Color** | **Typical Features** | **Reaction to Sun Exposure** | **Tanning Ability** |
| --- | --- | --- | --- | --- |
| **I** | Very fair, pale white | Often with freckles, blue or green eyes, red or blond hair | Always burns, never tans | None |
| **II** | Fair, light skin | Light eyes, light hair | Usually burns, tans minimally | Minimal |
| **III** | Medium, light to beige | Any eye or hair color | Sometimes mild burn, tans uniformly | Gradual tan |
| **IV** | Olive, moderate brown | Mediterranean, Asian, or Hispanic skin tones | Rarely burns, tans easily | Moderate to high |
| **V** | Brown, dark brown | Middle Eastern, Indian, Latin, or African descent | Very rarely burns, tans very easily | High |
| **VI** | Deeply pigmented dark brown to black | African or Aboriginal descent | Never burns, deeply pigmented | Very high |

### Preprocessing static subjects

**Minimization of unintended motion**

- Select the 500 consecutive frames with the smallest amount of interframe motion

$$
i_s = \arg\min_n \sum_{i=n}^{n+499} \left( \lvert I_i(\vec{x}) - I_{i+1}(\vec{x}) \rvert \right)
$$

$$
I_i(\vec{x}) = \frac{R_i(\vec{x}) + G_i(\vec{x}) + B_i(\vec{x})}{3}
$$

- Extraction of raw signals in each frame
    - Voila and Jones face detector
    - skin mask to remove all pixels containing facial hair and facial features that pollute the rPPG signal

### SNR Metric

- SNR as the ratio of the energy around the fundamental frequency and its firs harmonic and the remaining energy

$$
\mathrm{SNR} = 10 \log_{10} \left( \frac{\sum_{f=30}^{240} \left( U_t(f) \hat{S}(f) \right)^2}{\sum_{f=30}^{240} \left( \left( 1 - U_t(f) \right) \hat{S}(f) \right)^2}\right)
$$

- $\hat{S}(f)$ is the spectrum of the pulse signal $S$
- $U_t(f)$ is a binary template window in the frequency spectrum

### Benchmark

- Comparison of the chrominance based algorithm to BSS-based ones (ICA of Poh et al and PCA of Lewandowska et al)
- ICA
    - raw temporal traces for color channel C are detrended using smoothness priors approach
        - smoothing parameter of 10
        - cutoff frequency of 0.89 Hz
        - normalization ( $C_i$ is the raw temporal singal of a color channel, $\mu (C_i)$ is the mean and $\sigma (C_i)$ is the standard deviation of the color channels)
        
        $$
        C_{ni}\frac{C_i - \mu (C_i)}{\sigma (C_i)}
        $$
        
    - Signals decomposed using ICA based on the joint approximate diagonalization of eigenmatrices algorithm
    - Signal with highest peak in normalized power spectrum is selected
    - Filter the selected signal with 5 point averaging filter and bandpass filter (40 - 240 bpm)
- PCA
    - Raw RGB temporal traces obtained from a skin region are first filtered using an FIR bandpass filter with cutoff frequencies 40–240 bpm
    - Signals decomposed using PCA
    - Signal with highest peak in normalized power spectrum is selected

### Motion robustness

- Test with subjects exercising in a stationary bike and in a stepping device
- Seperate optimization and normalization in overlapping time intervals
    - Overlap-add using Hann windowing on individual intervals
    
    $$
    S_i = \sum_N w h_{N, i}S_{N, i}
    $$
    
    $$
    wh_{N, i} = 0,5 cos(2 \pi i/interval)
    $$
    
    - for interval number $N = [2i/interval]$, $S_{N, i}$ is the optimized signal from pictures in the interval
    - BSS based algorithms perform better with longer intervals - do not work with serious motion
    - Chrominance-based algorithm performs better with smaller intervals

## Results

|  | **RoverG** | **XoverY** | **Fixed** | **XsminαYs** | **ICA** | **PCA** |
| --- | --- | --- | --- | --- | --- | --- |
| **r:** | 1.00 | 1.00 | 0.99 | 1.00 | 0.97 | 0.99 |
| **B:** | 1.00 | 1.00 | 0.99 | 0.99 | 0.97 | 0.96 |
| **σ:** | 1.1 | 0.8 | 1.2 | 0.9 | 2.6 | 1.8 |
| **ε:** | 0.5 | 0.4 | 0.5 | 0.5 | 1.1 | 0.9 |
- r is the Person correlation coefficient
- B is the slope of linear fit
- $\sigma$ is the standard deviation
- $\epsilon$ is the RMSE

> the accuracy appears to be independent of the pulse rate of the subjects, which suggests the pulse rate range coverage of this technique is as broad as the one obtained with contact PPG sensors
> 
- SNR was bigger for smaller phototypes (best for types 1 and 2 and worst for type 6)
- Stepping exercise was the one where all methods showed worst performance as expected
- Chrominance-based algorithms showed better performance than BSS-based ones in exercise context

Chrominance-based methods can more quickly adapt to changing conditions and can perform well with shorter latency

- 92% agreement of rPPG (  $\sigma=1.96$)
- correlation coefficient of 1 for the best chrominance method
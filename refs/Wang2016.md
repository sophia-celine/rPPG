# A Novel Algorithm for Remote Photoplethysmography: Spatial Subspace Rotation

*W. Wang, S. Stuijk and G. de Haan, "A Novel Algorithm for Remote Photoplethysmography: Spatial Subspace Rotation," in IEEE Transactions on Biomedical Engineering, vol. 63, no. 9, pp. 1974-1984, Sept. 2016, doi: 10.1109/TBME.2015.2508602*

- good comparison comments between ICA, PBV and CHROM
- 2 main steps
    - in the spatial domain, a subspace of skin-pixels is constructed in RGB space
    - in the temporal domain, the rotation angle of spatial subspaces between subsequent frames is measured for pulse extraction

## Method

- Spatial subspace
    - takes the spatial distribution of skin-pixels into account
    
    $$
    C = \frac{V^T \cdot V}{N}
    $$
    
    - N> 0 is the number of skin pixels
    - V is a $N \times 3$ matrix vectorized from RGB channels of skin pixels in a video frame
    - C is a $3 \times 3$ symmetric correlation matix with nonegative values (not covariance matrix)
    - Decomposition of C gives the subspace of skin pixels
    
    $$
    C \cdot U = \Lambda \cdot U
    $$
    
    where
    
    $$
    det(C - \Lambda \cdot I) = 0
    $$
    
    - $U$ and $\Lambda$ are eigenvectors and eigenvalues (based on QR algorithm)
    - C can be expanded as:
    
    $$
    C = \lambda_1 \cdot u_1 \cdot u_1 + \lambda_2 \cdot u_2 \cdot u_2 + \lambda_3 \cdot u_3 \cdot u_3
    $$
    
    - $u_i$ is the column vector of U
    - $\lambda_i$ is the $i$th diagonal element of $\Lambda$
- U is defined as the new axis system of skin-pixels
    - the principal eigenvector $u_1$ is the main direction
        - least square estimation robust to spatial outliers
    - $u_2$ and $u_3$ are succeeding directions of variation that are orthogonal to $u_1$
- the method only works for rPPG as U has to be estimated from multiple pixel-sensors
- Also, the method depends on a well defined skin mask, as pixels from the background would disrupt he skin-pixels cluster

Subspace rotation

- modeling of the temporal relation between 2 subspaces as an instantaneous rotation and scaling
    - rotation between eigenvectors (direction change) is related to the different relative PPG-contributions  in RGB channels
    - change of eigenvalues (energy change) is related to the pulsatility of the measured skin
- As U consists of eigenvectors with unit norm, temporal changes cause only rotation
    - defnition of a temporal slide $l$ to analyze the subspace rotation
    - Roation in relation to a reference frame $U_{\tau}$:
    
    $$
    R = U_{t}^{\top} \, U_{\tau}= \begin{pmatrix}u_{1}^{t \top} \\u_{2}^{t \top} \\u_{3}^{t \top}\end{pmatrix}\cdot\begin{pmatrix}u_{1}^{\tau} & u_{2}^{\tau} & u_{3}^{\tau}\end{pmatrix}
    $$
    
- Rotation matrix:

$$
R = \begin{pmatrix}\cos(\theta_{11}) & \sin(\theta_{12}) & \sin(\theta_{13}) \\-\sin(\theta_{12}) & \cos(\theta_{22}) & \sin(\theta_{23}) \\-\sin(\theta_{13}) & -\sin(\theta_{23}) & \cos(\theta_{33})\end{pmatrix}
$$

- rotation between the principal eigenvector $u_1^t$ and orthonormal plane $(u_2^{\tau}$ $u_3^{\tau})$

$$
R' = (u_1^{t \top}) \cdot (u_2^{\tau} u_3^{\tau} ) = (u_1^{t \top} \cdot u_2^{\tau} u_1^{t \top} \cdot u_3^{\tau})
$$

- scale/energy change of the rotated subspace

$$
S = \sqrt{\lambda_1^t} \cdot \operatorname{diag} \left(\left(\begin{array}{cc}\sqrt{\lambda_2^{\tau}} & 0 \\0 & \sqrt{\lambda_3^{\tau}}\end{array}\right)^{-1}\right)=\begin{pmatrix}\dfrac{\sqrt{\lambda_1^t}}{\sqrt{\lambda_2^{\tau}}} \\\dfrac{\sqrt{\lambda_1^t}}{\sqrt{\lambda_3^{\tau}}}\end{pmatrix}
$$

- restrict S changes to the direction of subspace rotation

$$
SR = S \odot R'
$$

- $\odot$ is the elementwise multiplication
- SR backprojected into the original RGB space to analyze considering different temporal strides

$$
SR' = SR \cdot \begin{pmatrix}u_2^{\tau \top} \\u_3^{\tau \top}\end{pmatrix}
$$

- In a single stride, multiple SR′ between the reference frame and succeeding frames are estimated and concatenated, which gives 2 antiphase traces
- Cobine the anti-phase traces
    
    $$
    \vec{p} = SR'_1 - \frac{\sigma(\overrightarrow{SR'_1})}{\sigma(\overrightarrow{SR'_2})} \cdot \overrightarrow{SR'_2}
    $$
    
    - long-term pulse-signal $\vec{P}$ is estimated from successive strides using overlap-adding
        
        $$
        \overrightarrow{P}^{t-l} = \overrightarrow{P}^{t-l} + \left( \vec{p} - \mu(\vec{p}) \right)
        $$
        
    - $\vec{P}$ is a 1D signal with length K (total number of video frames)
        - initialized by zero-entries and constantly updated by $\vec{p}$

**Complete algorithm**

**Input**: a video sequence containing K frames

1:  **Initialize:** $\vec{P} = zeros(1, K)$ 

2:  **for $k=1, 2, ..., K$ do**

3:      $C^k = \frac{V^{k \top} \cdot V^k}{N}$

4:      $[U^k, \Lambda^k] = eigs(C^k)$ where $U^k =$  { $u^k_i$ }, $\Lambda^k =$  { $\lambda^k_i$ }

5:      **if** $\tau = k - l + 1 > 0$ then

6:          **for $t = \tau, \tau+1, ..., k$** do

7:              $SR' = \sqrt{\frac{\lambda_t^1}{\lambda^{\tau}_2}} \cdot u^{t \top}_1 \cdot u_2^{\tau} \cdot u_2^{\tau \top} + \sqrt{\frac{\lambda_1^t}{\lambda_3^{\tau}} } \cdot u_1^{t \top} \cdot u_3^{\tau} \cdot u_3^{\tau \top}$

8:              $\overrightarrow{SR'} \leftarrow$ concatenated by $SR'$

9:              **endfor**

10:          $\overrightarrow{p} = \overrightarrow{SR_1'} = \frac{\sigma(\overrightarrow{SR_1'})}{\sigma(\overrightarrow{SR_2'})} \cdot \overrightarrow{SR_2'}$

11:          $\overrightarrow{P}^{t-l} = \overrightarrow{P}^{t-l} + (\overrightarrow{p} - \mu(\overrightarrow{p}))$

12:          **end if**

13:      **end for**

**Output:** the pulse-signal $\overrightarrow{P}$

> In the temporal domain, pulsatile blood causes variations in RGB channels and, thus, changes the subspace of skin-pixels. Since the spatial subspace is constructed from spatially redundant skin-pixels without temporal normalization (i.e., dividing the RGB channels by their temporal mean), we cannot directly use the subspace translation (i.e., distance shift of spatial RGB mean) to measure pulse. This is because pulsatile variations without temporal normalization are proportional to the luminance intensity and, thus, in a multiplicative relationship. We model the temporal relation between two subspaces as an instantaneous rotation and scaling: 1) the rotation between eigenvectors (direction change) is related to the different relative PPG-contributions in RGB channels; and 2) the change of eigenvalues (energy change) is related to the pulsatility of the measured skin.
> 

## Experiments

- videos recorded with regular RGB camera
- uncompressed bitmap format
- 768x576 pixels
- 8-bit depth
- 20 fps
- finger-based pulse oximeter as groud-truth
- fluorescent lamp 1,5 m in front of the subject face
- 3 test scenarios
    - different skin tones (Fitzpatrick scale)
    - head motion
    - recovery from running exercise
- automatic selection of skin pixels
    - Wang, Wenjin, Sander Stuijk, and Gerard De Haan. "Exploiting spatial redundancy of image sensor for motion robust rPPG." IEEE transactions on Biomedical Engineering 62.2 (2014): 415-425.
    - OC-SVM classifier
- Metrics of evaluation
    - SNR of pulse frequency
        - same metric that the CHROM method uses
        - pulse frequnecy spectrum result
    - Pearson correlation of instant pulse-rate
        - instant pulse-rate defined as the inverse of the peak-to-peak interval
    - Precision of instant pulse-rate
    - Analysis of Variance (ANOVA)
- MATLAB implementation
- Processing in laptop with an Intel-Core-i7 processor (2.70 GHz) and 8-GB RAM
- Method parameter $l$ = 20 (temporal stride for measuring the subspace rotation)
    - considering 20 FPS

## Results

- 2SR (spatial subspace rotation) performed better than ICA, CHROM and PBV in pearson correlation and precision metrics inall considered scenarios (motion, exercise recovery and skin tone) and performed better in most scenarios in terms of SNR.
- 2SR preserve well respiration frequencies in medium and high running levels of exercise without interfering in pulse rate
    - this method can be useful fo respiration extraction as well

## Discussion

- weaknesses of 2SR
    - depends on multiple skin pixels in the spatial domain
    - measured skin pixels need to be in a single cluster
    - if the skin pixel number decreases or the skin mask is noisy (with non skin pixels) the algorithm performance drops
- temporal stride $l$
    - samller strides give bad SNR
    - longer strides can include long-term motion distortions in the subspace rotation estimation
    - the optimal parameter depends of the camera frame rate and the subject pulse rate